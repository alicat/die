// Generated by CoffeeScript 1.3.3
var express, path;

express = require('express');

path = require('path');

exports.createServer = function(die) {
  var app,
    _this = this;
  app = express.createServer();
  die.readConfig(app.settings.env);
  app.configure(function() {
    var publicDir, viewDir;
    app.set('port', die.options.port);
    viewDir = path.join(die.base, '/views');
    if (path.existsSync(viewDir)) {
      app.set('views', viewDir);
      app.set('view engine', 'jade');
    }
    publicDir = path.join(die.base, die.options["public"]);
    if (path.existsSync(publicDir)) {
      return app.use(express["static"](publicDir));
    } else {
      return app.use(express["static"](die.base));
    }
  });
  app.configure('test', function() {
    return app.set('port', die.options.port + 1);
  });
  app.configure('development', function() {
    app.use(express.logger());
    return app.use(express.errorHandler({
      dumpExceptions: true,
      showStack: true
    }));
  });
  app.configure('production', function() {
    return app.use(express.errorHandler());
  });
  if (die.options.cssPath) {
    app.get(die.options.cssPath, function(req, res) {
      res.header('Content-Type', 'text/css');
      try {
        return res.send(die.cssPackage().compile());
      } catch (err) {
        return console.error('CSS packaging error:', err);
      }
    });
  }
  if (die.options.jsPath) {
    app.get(die.options.jsPath, function(req, res) {
      res.header('Content-Type', 'application/javascript');
      try {
        return res.send(die.jsPackage().compile());
      } catch (err) {
        return console.error('JavaScript packaging error:', err);
      }
    });
  }
  app.run = function(func) {
    app.listen(app.settings.port, function() {
      console.log("" + app.settings.env + " server up and running at http://localhost:" + (app.address().port));
      if (typeof func === 'function') {
        return func();
      }
    });
    return app;
  };
  return app;
};

exports.enableDsl = function(app, func) {
  var verb, _fn, _i, _j, _len, _len1, _ref, _ref1, _results;
  if (typeof func !== 'function') {
    return;
  }
  _ref = ['get', 'post', 'put', 'del'];
  _fn = function(verb) {
    app["__orig_" + verb] = app[verb];
    return app[verb] = function(path, handler) {
      return app["__orig_" + verb](path, function(req, res, next) {
        var ctx;
        ctx = {
          app: app,
          body: req.body,
          next: next,
          params: req.params,
          query: req.query,
          request: req,
          response: res,
          session: req.session,
          settings: app.settings,
          json: function() {
            return res.json.apply(res, arguments);
          },
          redirect: function() {
            return res.redirect.apply(res, arguments);
          },
          render: function() {
            return res.render.apply(res, arguments);
          },
          send: function() {
            return res.send.apply(res, arguments);
          }
        };
        return handler.apply(ctx, req.params);
      });
    };
  };
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    verb = _ref[_i];
    _fn(verb);
  }
  func.call(app);
  _ref1 = ['get', 'post', 'put', 'del'];
  _results = [];
  for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
    verb = _ref1[_j];
    _results.push(app[verb] = app["__orig_" + verb]);
  }
  return _results;
};
